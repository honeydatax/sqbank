' Gambas class file

Const databases As String = "sqlmoney.lite" 
Public dbc3 As New Connection
Public Const reportss As String = "report.txt"

Public Sub Form_Open()

  If Not Exist(User.Home & "/" & databases) Then
    createdatabase()
   End If
    dbc3.type = "sqlite"
    dbc3.host = User.Home
    dbc3.name = databases
    dbc3.Open
    TableView1.Columns.Count = 7
    TableView2.Columns.Count = 6
    reloads()
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
  End

Public Sub reloads()
  Dim n As Integer
  Dim rs As Result
   rs = dbc3.Exec("select * ,SUM(moves.value) from acounts inner join moves on moves.acount=acounts.ID order by acounts.names ")  
   rs.MoveFirst()
   TableView1.Clear()
   If rs.Available Then
       
    TableView1.rows.Count = rs.Count + 1
    TableView1[0, 0].Text = "ID"
    TableView1[0, 1].Text = "NAME"
    TableView1[0, 2].Text = "email"
    TableView1[0, 3].Text = "address"
    TableView1[0, 4].Text = "phone"
    TableView1[0, 5].Text = "postal"
    For n = 1 To rs.Count
   
      TableView1[n, 0].Text = rs!ID
      TableView1[n, 1].Text = rs!names
      TableView1[n, 2].Text = rs!emails
      TableView1[n, 3].Text = rs!address
      TableView1[n, 4].Text = rs!phone
      TableView1[n, 5].Text = rs!postal
      TableView1[n, 6].Text = rs["SUM(moves.value)"]
      rs.MoveNext()
    Next
  End If
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End

Public Sub Button1_Click()
Dim rs As Result
  rs = dbc3.Exec("insert into acounts(ID,names,emails,address,phone,postal)values('" & TextBox1.Text & "','" & TextBox2.Text & "','" & TextBox3.Text & "','" & TextBox4.Text & "','" & TextBox5.Text & "','" & TextBox6.Text & "');")  
   reloads()
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End 
Public Sub createdatabase()
    Dim n As Integer
    Dim dbc As New Connection
    Dim dbc2 As New Connection
    Dim htable As Table
    Dim htable2 As Table
    dbc.type = "sqlite"
    dbc.host = User.Home
    dbc.Name = ""
    dbc.Open
    dbc.Databases.Add(databases)
    dbc.Close
    dbc2.type = "sqlite"
    dbc2.host = User.Home
    dbc2.name = databases
    dbc2.Open
    htable = dbc2.Tables.Add("acounts")
    htable.Fields.Add("ID", db.Integer)
    htable.Fields.Add("names", db.String, 30)
    htable.Fields.Add("emails", db.String, 25)
    htable.Fields.Add("address", db.String, 25)
    htable.Fields.Add("phone", db.String, 25)
    htable.Fields.Add("postal", db.String, 25)
    htable.PrimaryKey = ["ID"]
    htable.Update()
    dbc2.Exec("create table moves(ID INTEGER PRIMARY KEY AUTOINCREMENT ,acount integer not null, dates text(10) not null, names text(25) not null, value float not null); ")
    dbc2.Close
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End

Public Sub listmoves()
  Dim n As Integer
  Dim rs As Result
  Dim rs1 As Result
  Dim rs2 As Result
  Dim sums As Float
   rs2 = dbc3.Exec("select SUM(value) from moves where acount==" & TextBox7.text)  
   If rs2.Available Then
     rs2.MoveFirst()
     Label13.Caption = Str(rs2["SUM(value)"])
   Endif

   rs1 = dbc3.Exec("select * from acounts where ID=" & TextBox7.text)  
   If rs1.Available Then
     rs1.MoveFirst()
     TextBox8.text = rs1!names
   Endif
   rs = dbc3.Exec("select * from moves where acount=" & TextBox7.text)  
   rs.MoveFirst()
   TableView2.Clear()
   sums = 0
   If rs.Available Then
    TableView2.rows.Count = rs.Count + 1
    TableView2[0, 0].Text = "ID"
    TableView2[0, 1].Text = "acount"
    TableView2[0, 2].Text = "dates"
    TableView2[0, 3].Text = "names"
    TableView2[0, 4].Text = "value"
    TableView2[0, 5].Text = "==sums"
    For n = 1 To rs.Count
      sums = sums + rs!value
      TableView2[n, 0].Text = rs!ID
      TableView2[n, 1].Text = rs!acount
      TableView2[n, 2].Text = rs!dates
      TableView2[n, 3].Text = rs!names
      TableView2[n, 4].Text = rs!value
      TableView2[n, 5].Text = Str(sums)
      rs.MoveNext()
    Next
  End If
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End
Public Sub Button2_Click()
  listmoves()
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End

Public Sub Button3_Click()
Dim rs As Result
  rs = dbc3.Exec("insert into moves(acount,dates,names,value)values('" & TextBox10.Text & "','" & TextBox11.Text & "','" & TextBox12.Text & "','" & TextBox13.Text & "');")  
  listmoves()  
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End 

  

Public Sub Button4_Click()
     Dim rs As Result
  		rs = dbc3.Exec("delete from moves where acount =" & TextBox14.text & "; ")
  		rs = dbc3.Exec("delete from acounts where ID =" & TextBox14.text & "; ")
      reloads()
      listmoves()
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End

Public Sub Button5_Click()
     Dim rs As Result
  		rs = dbc3.Exec("delete from moves where ID =" & TextBox15.text & "; ")
      reloads()
      listmoves()
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
  

End
Public Sub reportsmoves()
  Dim n As Integer
  Dim rs As Result
  Dim rs1 As Result
  Dim rs2 As Result
  Dim sums As Float
  Dim f As File
  Dim f45 As String
  Dim IDs As String
  Dim acountss As String
  Dim ddates As String
  Dim namess As String
  Dim valuess As String
  Dim sumss As String
  f45 = String(45, " _ ")
    f = Open user.Home & "/" & reportss For Create
    rs1 = dbc3.Exec("select * from acounts where ID=" & TextBox16.text)  
   If rs1.Available Then
     rs1.MoveFirst()
     Print #f, TextBox16.text
     Print #f, rs1!names
   Endif
   Print #f, f45
   rs = dbc3.Exec("select * from moves where acount=" & TextBox16.text)  
   rs.MoveFirst()
   sums = 0
   If rs.Available Then
      ids = "ID"
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
     ids = "acount"
     ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
     ids = "dates"
     ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
     ids = "names"
     ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
     ids = "value"
     ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
     ids = "==sums"
     ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids
     For n = 1 To rs.Count
       sums = sums + rs!value
      ids = rs!ID
     ids = ids & Space(45 - Len(ids)) & "|"
      Print #f, ids;
     ids = rs!acount
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
      ids = rs!dates
      ids = ids & Space(45 - Len(ids)) & "|"
      Print #f, ids;
     ids = rs!dates
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
      ids = rs!value
      ids = ids & Space(45 - Len(ids)) & "|"
      Print #f, ids;
      ids = Str(sums)
      ids = ids & Space(45 - Len(ids)) & "|"
      Print #f, ids
      rs.MoveNext()
    Next
   Print #f, f45
   rs2 = dbc3.Exec("select SUM(value) from moves where acount==" & TextBox16.text)  
   If rs2.Available Then
     rs2.MoveFirst()
        Print #f, Str(rs2["SUM(value)"])
   Endif
Close #f
  End If
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End


Public Sub Button6_Click()
  reportsmoves()
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End

Public Sub reportacounts()
  Dim n As Integer
  Dim rs As Result
  Dim f45 As String
  Dim ids As String
  Dim f As File 
  f45 = String(45, " _ ")
    f = Open user.Home & "/" & reportss For Create
   rs = dbc3.Exec("select * from acounts")  
   rs.MoveFirst()
   TableView1.Clear()
   If rs.Available Then
       
    TableView1.rows.Count = rs.Count + 1
      ids = "ID"
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
    ids = "NAME"
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;

    ids = "email"
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;

    ids = "address"
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;

    ids = "phone"
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;

    ids = "postal"
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids
    For n = 1 To rs.Count
      ids = rs!ID
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
      ids = rs!names
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
      ids = rs!emails
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
      ids = rs!address
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
      ids = rs!phone
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids;
      ids = rs!postal
      ids = ids & Space(45 - Len(ids)) & "|"
     Print #f, ids
      rs.MoveNext()
    Next
  End If
Close #f
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End

Public Sub Button7_Click()

    reportacounts()  
    Finally
    Catch
      Message.Warning("error :" & Error.Text, "ok")
End
